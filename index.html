<!-- Version 1.10.1 — Cropping bug fix + functional crop -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tier List</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
/* same styles as your v1.10 ... */
body{margin:0;padding:0;font-family:Arial,sans-serif;background:#f4f4f4;}
h1{text-align:center;margin:10px;}
.tier-container{display:flex;align-items:center;flex-wrap:wrap;margin:5px 10px;}
.label{min-width:120px;padding:10px 15px;margin-right:5px;text-align:center;font-weight:bold;border-radius:12px;color:#fff;font-size:16px;box-shadow:2px 2px 8px rgba(0,0,0,.3);cursor:pointer;text-shadow:-1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000,1px 1px 0 #000;display:flex;align-items:center;gap:5px;}
.color-picker{width:18px;height:18px;border:2px solid #000;border-radius:50%;cursor:pointer;}
.remove-cat{width:18px;height:18px;display:flex;align-items:center;justify-content:center;background:red;color:white;border-radius:50%;font-size:14px;cursor:pointer;}
.tier{display:flex;flex-wrap:wrap;gap:5px;padding:10px;min-height:80px;border-radius:12px;margin:5px 0;background:#fff;box-shadow:1px 1px 6px rgba(0,0,0,.2);flex:1;cursor:pointer;}
.unranked{display:flex;flex-wrap:wrap;gap:5px;padding:10px;min-height:80px;background:#ddd;border:2px dashed #999;margin:5px 10px 20px;border-radius:12px;}
.img-wrapper,.text-wrapper{position:relative;width:60px;height:60px;border-radius:6px;overflow:hidden;cursor:pointer;}
.img-wrapper img{width:100%;height:100%;object-fit:cover;transition: transform .15s;}
.img-wrapper:hover img{transform:scale(1.06);}
.img-wrapper.selected,.text-wrapper.selected{outline:3px solid #00e0ff;outline-offset:2px;}
.delete-btn{position:absolute;top:-6px;right:-6px;background:rgba(255,0,0,.9);color:#fff;border:0;border-radius:50%;width:20px;height:20px;line-height:20px;font-size:14px;cursor:pointer;}
/* Text item */
.text-bg{position:absolute;inset:0;border-radius:6px;background:rgba(0,0,0,.35);backdrop-filter: blur(6px);}
.text-content{position:relative;z-index:1;color:#fff;font-weight:700;width:100%;height:100%;display:flex;align-items:center;justify-content:center;text-align:center;padding:6px;box-sizing:border-box;}
.text-content span{display:block;max-width:100%;max-height:100%;word-wrap:break-word;overflow:hidden;text-shadow:-1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000,1px 1px 0 #000;}
/* Island */
#island{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);background:#888;padding:10px;border-radius:12px;box-shadow:2px 2px 12px rgba(0,0,0,.4);z-index:1000;transition:width 0.3s,max-height 0.3s;overflow:hidden;width:250px;max-height:40px;display:flex;flex-direction:column;}
#island.expanded{max-height:300px;width:400px;}
#islandHeader{cursor:pointer;color:#fff;font-weight:bold;margin-bottom:5px;display:flex;align-items:center;gap:10px;}
.icon-btn{width:28px;height:28px;border-radius:50%;display:flex;justify-content:center;align-items:center;background:#aaa;color:#fff;cursor:pointer;font-size:20px;transition:transform .15s;opacity:0;}
#island.expanded .icon-btn{opacity:1;}
#islandContent{display:none;flex-direction:column;margin-top:10px;}
#island.expanded #islandContent{display:flex;}
.island-btn{margin:3px;padding:4px 6px;border:none;border-radius:4px;background:#aaa;color:#fff;cursor:pointer;}
.controls{display:flex;gap:10px;align-items:center;justify-content:center;margin:8px 10px;}
.controls .material-icons{vertical-align:middle;}
/* Cropping overlay */
#cropOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);justify-content:center;align-items:center;z-index:10000;}
#cropBox{position:absolute;border:2px dashed #00e0ff;aspect-ratio:1/1;cursor:move;}
</style>
</head>
<body>
<h1 id="tierListTitle" contenteditable="true">My Tier List</h1>
<div class="controls">
  <input type="file" id="imageUpload" accept="image/*" multiple>
  <button id="addTextBtn" class="island-btn"><span class="material-icons" style="font-size:16px">text_fields</span> Add Text</button>
</div>
<div id="tiers"></div>
<h3 style="margin-left:10px;">Unranked</h3>
<div class="unranked" id="unranked"></div>
<!-- Island Panel -->
<div id="island">
  <div id="islandHeader">Options
    <div style="margin-left:auto;display:flex;gap:6px;">
      <div id="saveIcon" class="icon-btn material-icons" title="Save">save</div>
      <div id="loadIcon" class="icon-btn material-icons" title="Load">folder_open</div>
      <div id="addCatIcon" class="icon-btn material-icons" title="Add Category">add</div>
      <div id="creditsIcon" class="icon-btn material-icons" title="Credits">info</div>
      <div id="editModeToggle" class="icon-btn material-icons" title="Edit Mode">edit</div>
    </div>
  </div>
  <div id="islandContent">
    <div id="addCategoryPanel" style="display:none;margin-top:5px;">
      <label>Category Name: <input type="text" id="newCategoryName"/></label><br>
      <div id="bgColors"></div>
      <button id="createCategoryBtn" class="island-btn">Create Category</button>
    </div>
    <div id="creditsPanel" style="display:none;margin-top:5px;color:white;">Made by AI — GPT-5 Mini, OpenAI.</div>
  </div>
</div>
<!-- Crop Overlay -->
<div id="cropOverlay">
  <div style="position:relative;max-width:80vw;max-height:80vh;">
    <img id="cropImage" style="max-width:100%;max-height:100%;display:block;"/>
    <div id="cropBox"></div>
  </div>
  <button id="cropButton" class="island-btn" style="position:absolute;bottom:20px;">OK</button>
</div>
<input type="file" id="fileInput" accept=".json" style="display:none"/>
<script>
// === Your original JS kept intact, only modifying crop ===
let cropQueue=[], cropping=false, cropX=50,cropY=50,cropSize=100,dragging=false,offsetX,offsetY;

function addToUnranked(src){
  let imgObj=new Image(); imgObj.src=src;
  imgObj.onload=()=>{
    let w=imgObj.width,h=imgObj.height;
    if(Math.abs(w-h)/Math.max(w,h)>0.2){ cropQueue.push(src); if(!cropping) showCrop(); }
    else{ document.getElementById("unranked").appendChild(createImageWrapper(src)); saveDataToLocal(); }
  }
}

function showCrop(){
  if(cropQueue.length===0){cropping=false;return;}
  cropping=true;
  const src=cropQueue[0];
  document.getElementById("cropImage").src=src;
  document.getElementById("cropOverlay").style.display="flex";
  // reset crop box
  const cropBox=document.getElementById("cropBox");
  cropBox.style.width="100px"; cropBox.style.height="100px"; cropBox.style.left="50px"; cropBox.style.top="50px";
}

document.getElementById("cropBox").addEventListener("mousedown",e=>{
  dragging=true; offsetX=e.offsetX; offsetY=e.offsetY;
});
document.addEventListener("mouseup",()=>dragging=false);
document.addEventListener("mousemove",e=>{
  if(!dragging) return;
  const box=document.getElementById("cropBox");
  box.style.left=(e.pageX-offsetX)+"px";
  box.style.top=(e.pageY-offsetY)+"px";
});

document.getElementById("cropButton").addEventListener("click",()=>{
  const img=document.getElementById("cropImage");
  const box=document.getElementById("cropBox");
  const rect=box.getBoundingClientRect();
  const imgRect=img.getBoundingClientRect();
  // calculate crop relative coords
  const scaleX=img.naturalWidth/imgRect.width;
  const scaleY=img.naturalHeight/imgRect.height;
  const x=(rect.left-imgRect.left)*scaleX;
  const y=(rect.top-imgRect.top)*scaleY;
  const size=rect.width*scaleX;
  const canvas=document.createElement("canvas");
  canvas.width=200; canvas.height=200;
  const ctx=canvas.getContext("2d");
  ctx.drawImage(img,x,y,size,size,0,0,200,200);
  const cropped=canvas.toDataURL();
  document.getElementById("unranked").appendChild(createImageWrapper(cropped));
  saveDataToLocal();
  cropQueue.shift();
  document.getElementById("cropOverlay").style.display="none";
  cropping=false;
  if(cropQueue.length>0) showCrop();
});
</script>
<footer style="position:fixed;right:10px;bottom:10px;background:rgba(100,100,100,.55);color:#fff;font-size:12px;padding:4px 8px;border-radius:8px;opacity:.85;z-index:100000;">Version 1.10.1 — Cropping bug fix</footer>
</body>
</html>
